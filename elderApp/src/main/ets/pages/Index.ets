import router from '@ohos.router';
import { ElderlyStore, elderlyStore } from '../models/ElderlyStore';
import { ActivityStatus, TimeUtil } from 'shared';

@Entry
@Component
struct Index {
  @State store: ElderlyStore = elderlyStore;
  @State isRunning: boolean = true;

  // ç»Ÿä¸€å®šä¹‰é…ç½®
  private readonly TitleSize: number = 24;
  private readonly LabelSize: number = 18;
  private readonly ValueSize: number = 24; // ç¨å¾®è°ƒå¤§ä¸€ç‚¹ï¼Œæ›´æœ‰è§†è§‰å†²å‡»åŠ›
  private readonly HeartRateLimit: number = 100; // å¿ƒç‡æŠ¥è­¦ä¸Šé™

  // 1. è®¡ç®—å¿ƒç‡é¢œè‰²çš„é€»è¾‘
  private getHeartRateColor(): string {
    const hr = this.store.currentStatus.heartRate ?? 0;
    if (hr > this.HeartRateLimit) {
      return '#D0021B'; // è¶…è¿‡é™å€¼æ˜¾ç¤ºçº¢è‰²
    }
    return '#07C160'; // æ­£å¸¸æ˜¾ç¤ºç»¿è‰²
  }

  // 2. è®¡ç®—ç”µé‡é¢œè‰²çš„é€»è¾‘
  private getBatteryColor(): string {
    const battery = this.store.currentStatus.batteryLevel ?? 0;
    if (battery > 60) {
      return '#07C160'; // é«˜äº60ç»¿è‰²
    }
    if (battery >= 20) {
      return '#FA8C16'; // 20-60æ©™è‰²
    }
    return '#D0021B'; // 20ä»¥ä¸‹çº¢è‰²
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨çŠ¶æ€æ 
      Row() {
        Column() {
          Text('å¥åº·çŠ¶æ€ï¼šæ­£å¸¸')
            .fontSize(this.TitleSize)
            .fontWeight(FontWeight.Bold)
            .fontColor('#111')
          Text('æ•°æ®æ¯ 10 ç§’è‡ªåŠ¨åŒæ­¥')
            .fontSize(14)
            .fontColor('#999')
            .margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)

        Blank()

        Image($r('app.media.icon_setting'))
          .width(28).height(28)
          .onClick(() => router.pushUrl({ url: 'pages/Settings' }))
      }
      .width('100%')
      .padding({ left: 24, right: 24, top: 40, bottom: 24 })
      .backgroundColor('#FFF')

      // 2. æ ¸å¿ƒæŒ‡æ ‡åˆ—è¡¨
      List({ space: 12 }) {
        ListItem() {
          // ä¼ å…¥è®¡ç®—å‡ºçš„é¢œè‰²
          this.buildMetricRow('â¤ï¸ å®æ—¶å¿ƒç‡', `${this.store.currentStatus.heartRate ?? '--'}`, 'æ¬¡/åˆ†', this.getHeartRateColor())
        }
        ListItem() {
          this.buildMetricRow('ğŸš¶ å½“å‰çŠ¶æ€', this.getActivityStatusText(), '', '#111')
        }
        ListItem() {
          // ä¼ å…¥è®¡ç®—å‡ºçš„é¢œè‰²ï¼Œå¹¶è¯»å–çœŸå®ç”µé‡
          this.buildMetricRow('ğŸ”‹ è®¾å¤‡ç”µé‡', `${this.store.currentStatus.batteryLevel ?? '--'}`, '%', this.getBatteryColor())
        }
        ListItem() {
          this.buildMetricRow('ğŸ“ æœ€è¿‘ä½ç½®', 'å®¶é™„è¿‘', '', '#111')
        }
      }
      .width('100%')
      .layoutWeight(1)
      .padding(16)

      // 3. åº•éƒ¨ç´§æ€¥æ“ä½œåŒº
      Column() {
        Button('ç´§æ€¥æ±‚åŠ© (SOS)')
          .width('100%')
          .height(72)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .backgroundColor('#D0021B')
          .borderRadius(16)
          .onClick(() => router.pushUrl({ url: 'pages/Emergency' }))
      }
      .padding(20)
      .backgroundColor('#FFF')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7Fa')
  }

  // âš ï¸ 3. ä¿®æ”¹äº†å‚æ•°ï¼Œå¢åŠ äº† valueColor
  @Builder buildMetricRow(label: string, value: string, unit: string, valueColor: string) {
    Row() {
      Text(label)
        .fontSize(this.LabelSize)
        .fontColor('#444')

      Blank()

      Row() {
        Text(value)
          .fontSize(this.ValueSize)
          .fontWeight(FontWeight.Bold) // åŠ ç²—æ•°å€¼ï¼Œæ›´æ˜“è¯»
          .fontColor(valueColor) // ä½¿ç”¨åŠ¨æ€é¢œè‰²
        if (unit) {
          Text(unit)
            .fontSize(14)
            .fontColor('#999')
            .margin({ left: 4, top: 6 })
        }
      }
    }
    .width('100%')
    .padding(24)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
  }

  private getActivityStatusText(): string {
    const status = this.store.currentStatus.activityStatus ?? ActivityStatus.UNKNOWN;
    switch (status) {
      case ActivityStatus.STILL: return 'é™æ­¢';
      case ActivityStatus.WALKING: return 'è¡Œèµ°';
      case ActivityStatus.RUNNING: return 'è·‘æ­¥';
      default: return 'æœªçŸ¥';
    }
  }
}
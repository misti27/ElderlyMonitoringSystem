import { FamilyStore } from '../models/FamilyStore';
import { User, ActivityStatus, LocationData } from 'shared';

@Component
export default struct Monitor {
  @Consume('familyStore') store: FamilyStore;

  // æ ¼å¼åŒ–ä½ç½®æ˜¾ç¤º
  private getLocationStr(): string {
    const status = this.store.elderlyStatus;
    if (status && status.location && (status.location.latitude !== 0)) {
      return "æœé˜³å…¬å›­"; // å®é™…å¼€å‘å»ºè®®æ¥é€†åœ°ç†ç¼–ç 
    }
    return 'è·å–ä½ç½®ä¸­...';
  }

  build() {
    Stack({ alignContent: Alignment.Top }) {
      // èƒŒæ™¯è‰²
      Column().width('100%').height('100%').backgroundColor('#F8FAFC')

      Scroll() {
        Column({ space: 20 }) {
          // 1. é¡¶éƒ¨ï¼šè€äººåˆ‡æ¢ & ç´§æ€¥å‘¼å«æŒ‰é’®
          this.buildTopHeader()

          if (this.store.currentElderly) {
            // 2. å®æ—¶å®‰å±çŠ¶æ€ï¼ˆè¿™æ˜¯å­å¥³æœ€å…³å¿ƒçš„ï¼šå¹³å®‰è¿˜æ˜¯å±é™©ï¼‰
            this.buildSafetyStatusCard()

            // 3. æ ¸å¿ƒå¥åº·æŒ‡æ ‡ç½‘æ ¼ï¼ˆå‚è€ƒå›¾ç‰‡ä¸­çš„æ•°æ®æ’ç‰ˆï¼‰
            this.buildVitalGrid()

            // 4. ä»Šæ—¥æ´»åŠ¨è¶‹åŠ¿ï¼ˆå¤åˆ»å›¾ç‰‡é‡Œçš„è“è‰²æ›²çº¿å›¾æ¦‚å¿µï¼‰
            this.buildActivityCurve()

            // 5. è®¾å¤‡ç›‘æ§ï¼ˆä¿¡å·ã€ç”µé‡ï¼Œå‚è€ƒå›¾ç‰‡ä¸­çš„çŠ¶æ€å›¾æ ‡ï¼‰
            this.buildDeviceStatusCard()

          } else {
            this.buildEmptyState()
          }

          Row().height(80) // åº•éƒ¨å¯¼èˆªç•™ç™½
        }
        .padding({ left: 16, right: 16, top: 16 })
      }
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
  }

  // --- ç»„ä»¶ï¼šé¡¶éƒ¨å¯¼èˆª ---
  @Builder buildTopHeader() {
    Row() {
      // è€äººåˆ‡æ¢æŒ‰é’®
      Row() {
        ForEach(this.store.elderlyList, (item: User) => {
          Text(item.name)
            .fontSize(this.store.currentElderly?.id === item.id ? 18 : 14)
            .fontWeight(this.store.currentElderly?.id === item.id ? FontWeight.Bold : FontWeight.Normal)
            .fontColor(this.store.currentElderly?.id === item.id ? '#1A1A1A' : '#999')
            .margin({ right: 16 })
            .onClick(() => this.store.switchElderly(item.id))
        })
      }

      Blank()

      // ç´§æ€¥ç”µè¯æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Text('ğŸ“').fontSize(18)
      }
      .width(44).height(44)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 10, color: '#15000000' })
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
  }

  // --- ç»„ä»¶ï¼šå®æ—¶å®‰å±çŠ¶æ€å¡ç‰‡ ---
  @Builder buildSafetyStatusCard() {
    Column() {
      Row() {
        // æ ¹æ®çŠ¶æ€åˆ‡æ¢å›¾æ ‡é¢œè‰²
        Stack() {
          Circle({ width: 60, height: 60 })
            .fill(this.store.elderlyStatus?.isFall ? '#FFF1F0' : '#F6FFED')
          Text(this.store.elderlyStatus?.isFall ? 'â—' : 'ğŸ›¡ï¸').fontSize(30)
        }

        Column() {
          Text(this.store.elderlyStatus?.isFall ? 'ç›‘æµ‹åˆ°ç–‘ä¼¼è·Œå€’ï¼' : 'å½“å‰çŠ¶æ€ï¼šå¹³å®‰')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.store.elderlyStatus?.isFall ? '#FF4D4F' : '#52C41A')

          Text(this.getActivityDesc())
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 16 })

        Blank()

        if (this.store.elderlyStatus?.isFall) {
          Button('ç«‹å³å¤„ç†')
            .backgroundColor('#FF4D4F')
            .height(32)
            .fontSize(12)
        }
      }
      .width('100%')
    }
    .padding(24)
    .backgroundColor('#FFFFFF')
    .borderRadius(24)
    .shadow({ radius: 20, color: '#08000000', offsetY: 10 })
  }

  // --- ç»„ä»¶ï¼šæ ¸å¿ƒå¥åº·ç½‘æ ¼ ---
  @Builder buildVitalGrid() {
    Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
      this.buildVitalItem('â¤ï¸', 'å®æ—¶å¿ƒç‡', `${this.store.elderlyStatus?.heartRate ?? '--'}`, 'bpm', '#FF4D4F')
      this.buildVitalItem('ğŸ“', 'æœ€è¿‘ä½ç½®', this.getLocationStr(), '', '#1890FF')
    }
  }

  @Builder buildVitalItem(icon: string, label: string, val: string, unit: string, color: string) {
    Column() {
      Row() {
        Text(icon).fontSize(14).margin({ right: 4 })
        Text(label).fontSize(12).fontColor('#999')
      }
      Row() {
        Text(val).fontSize(22).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
        Text(unit).fontSize(12).fontColor('#999').margin({ left: 4, top: 6 })
      }.margin({ top: 8 })

      // åº•éƒ¨è£…é¥°æ¡ï¼Œå¢åŠ ç²¾è‡´æ„Ÿ
      Rect().width(30).height(3).radius(1.5).fill(color).margin({ top: 12 }).opacity(0.6)
    }
    .width('47%') // ä¸¤åˆ—å¸ƒå±€
    .padding(20)
    .margin({ bottom: 16 })
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .shadow({ radius: 10, color: '#05000000', offsetY: 5 })
    .alignItems(HorizontalAlign.Start)
  }

  // --- ç»„ä»¶ï¼šä»Šæ—¥æ´»åŠ¨è¶‹åŠ¿ï¼ˆå¤åˆ»å›¾ç‰‡ä¸­çš„æ›²çº¿å›¾é£æ ¼ï¼‰ ---
  @Builder buildActivityCurve() {
    Column() {
      Row() {
        Text('ä»Šæ—¥æ´»è·ƒåº¦è¶‹åŠ¿').fontSize(16).fontWeight(FontWeight.Bold)
        Blank()
        Text('æŸ¥çœ‹è½¨è¿¹ >').fontSize(12).fontColor('#999')
      }.width('100%').margin({ bottom: 15 })

      Row() {
        Text('08:00').fontSize(10).fontColor('#CCC')
        Text('12:00').fontSize(10).fontColor('#CCC')
        Text('16:00').fontSize(10).fontColor('#CCC')
        Text('20:00').fontSize(10).fontColor('#CCC')
      }.width('100%').justifyContent(FlexAlign.SpaceBetween)
    }
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(24)
    .shadow({ radius: 15, color: '#08000000' })
  }

  // --- ç»„ä»¶ï¼šè®¾å¤‡çŠ¶æ€ï¼ˆå­å¥³å…³å¿ƒçš„ï¼šè®¾å¤‡æœ‰æ²¡ç”µï¼Œä¿¡å·å¥½ä¸å¥½ï¼‰ ---
  @Builder buildDeviceStatusCard() {
    Row() {
      Column() {
        Text('è®¾å¤‡åœ¨çº¿').fontSize(14).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
        Text('åä¸º Mate 60 Pro').fontSize(11).fontColor('#999').margin({ top: 4 })
      }.alignItems(HorizontalAlign.Start)

      Blank()

      // ä¿¡å·å¼ºåº¦ï¼ˆå‚è€ƒå›¾ç‰‡é‡Œçš„ç»¿è‰²ä¿¡å·å›¾æ ‡ï¼‰
      Row() {
        Text('ğŸ“¶').fontSize(12).margin({ right: 4 })
        Text('ä¿¡å·å¼º').fontSize(12).fontColor('#52C41A')
      }.margin({ right: 16 })

      // ç”µé‡
      Row() {
        Text('ğŸ”‹').fontSize(12).margin({ right: 4 })
        Text(`${this.store.elderlyStatus?.batteryLevel ?? 0}%`).fontSize(12).fontColor('#1A1A1A')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#f5f7fa') // æµ…è“è‰²æ·¡é›…åº•è‰²
    .borderRadius(16)
    .border({ width: 1, color: '#D0E7FF' })
  }

  @Builder buildEmptyState() {
    Column() {
      Text('è¯·é€‰æ‹©è¦å…³æ³¨çš„è€äºº').fontColor('#999').margin({ top: 100 })
    }.width('100%')
  }

  private getActivityDesc(): string {
    const status = this.store.elderlyStatus?.activityStatus;
    switch (status) {
      case ActivityStatus.STILL: return 'æ­£åœ¨ä¼‘æ¯ï¼Œå·²æŒç»­ 2 å°æ—¶';
      case ActivityStatus.WALKING: return 'æ­£åœ¨æˆ·å¤–æ•£æ­¥';
      case ActivityStatus.RUNNING: return 'æ­£åœ¨æ™¨ç»ƒ';
      default: return 'çŠ¶æ€å·²ç¦»çº¿';
    }
  }
}
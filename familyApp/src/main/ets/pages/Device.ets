import { FamilyStore } from '../models/FamilyStore';
import promptAction from '@ohos.promptAction';

// 1. å®šä¹‰è®¾å¤‡é…ç½®çš„æ•°æ®ç»“æž„
interface DeviceConfig {
  hrLimit: string;
  sampleRate: string;
  fallSensitivity: string;
  wearDetection: string;
}

@Component
export default struct Device {
  @Consume('familyStore') store: FamilyStore;

  // 2. å°†æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡ç»“æž„ä¸­
  @State config: DeviceConfig = {
    hrLimit: '120 bpm',
    sampleRate: 'æ¯10ç§’ä¸€æ¬¡',
    fallSensitivity: 'ä¸­ç­‰',
    wearDetection: 'å·²å¼€å¯'
  };

  build() {
    Column() {
      this.buildDeviceHeader()

      Scroll() {
        Column({ space: 16 }) {
          this.buildStatusPanel()

          Column() {
            Text('è®¾å¤‡è¿œç¨‹é…ç½®')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 12, left: 4 })
              .alignSelf(ItemAlign.Start)

            Column() {
              // ä¼ å…¥ config å¯¹è±¡ä¸­çš„å…·ä½“å±žæ€§
              this.buildMenuRow('å¿ƒçŽ‡æŠ¥è­¦ä¸Šé™', this.config.hrLimit, true, () => {
                this.handleSelect('hrLimit', 'è®¾ç½®å¿ƒçŽ‡ä¸Šé™', ['100 bpm', '120 bpm', '140 bpm']);
              })

              this.buildMenuRow('é‡‡æ ·é¢‘çŽ‡', this.config.sampleRate, true, () => {
                this.handleSelect('sampleRate', 'é€‰æ‹©é‡‡æ ·é¢‘çŽ‡', ['æ¯1ç§’ä¸€æ¬¡', 'æ¯10ç§’ä¸€æ¬¡', 'æ¯30ç§’ä¸€æ¬¡']);
              })

              this.buildMenuRow('è·Œå€’æ£€æµ‹çµæ•åº¦', this.config.fallSensitivity, true, () => {
                this.handleSelect('fallSensitivity', 'è®¾ç½®çµæ•åº¦', ['é«˜', 'ä¸­ç­‰', 'ä½Ž']);
              })

              this.buildMenuRow('ä½©æˆ´æ£€æµ‹', this.config.wearDetection, false, () => {
                // å¼€å…³é€»è¾‘ç›´æŽ¥åˆ‡æ¢
                this.config.wearDetection = this.config.wearDetection === 'å·²å¼€å¯' ? 'å·²å…³é—­' : 'å·²å¼€å¯';
              })
            }
            .backgroundColor('#ffffff')
            .borderRadius(16)
          }
          .width('100%')

          Button('åŒæ­¥åˆ°è€äººæ‰‹æœº')
            .width('100%')
            .height(50)
            .margin({ top: 10, bottom: 40 })
            .onClick(() => {
              // è¿™é‡Œå¯ä»¥æŠŠ this.config è¿™ä¸ªæ•°æ®ç»“æž„å‘é€ç»™åŽç«¯
              console.info('å½“å‰å­˜å‚¨çš„æ•°æ®ç»“æž„: ' + JSON.stringify(this.config));
              promptAction.showToast({ message: 'åŒæ­¥æˆåŠŸ' });
            })
        }
        .padding(16)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f7fa')
  }

  // --- æŠ½å–çš„é€šç”¨é€‰æ‹©å¤„ç†å‡½æ•°ï¼Œè§£å†³â€œæ²¡ååº”â€çš„é—®é¢˜ ---
  private handleSelect(key: string, title: string, options: string[]) {
    promptAction.showActionMenu({
      title: title,
      buttons: [
        { text: options[0], color: '#333' },
        { text: options[1], color: '#333' },
        { text: options[2], color: '#333' }
      ]
    }).then(result => {
      // å…³é”®ï¼šåˆ¤æ–­ç´¢å¼•ï¼Œç¡®ä¿å­˜å‚¨åˆ°æ•°æ®ç»“æž„ä¸­
      if (result.index >= 0) {
        const newValue = options[result.index];
        // åŠ¨æ€æ›´æ–°å¯¹è±¡å±žæ€§ï¼Œè§¦å‘ UI åˆ·æ–°
        if (key === 'hrLimit') this.config.hrLimit = newValue;
        if (key === 'sampleRate') this.config.sampleRate = newValue;
        if (key === 'fallSensitivity') this.config.fallSensitivity = newValue;

        promptAction.showToast({ message: `å·²è®¾ä¸º: ${newValue}` });
      }
    }).catch((err: BusinessError) => {
      console.error("err:" + err);
    })
  }

  // --- ä¿æŒåŽŸç‰ˆé«˜çº§æ„Ÿ UI ä¸å˜ ---

  @Builder buildDeviceHeader() {
    Column() {
      Row() {
        Stack() {
          Circle({ width: 70, height: 70 }).fill('#ffffff').opacity(0.2)
          Text('ðŸ“±').fontSize(34)
        }.margin({ right: 20 })
        Column() {
          Text('æˆ‘çš„æ™ºèƒ½è®¾å¤‡').fontSize(20).fontWeight(FontWeight.Bold).fontColor('#ffffff')
          Text('åœ¨çº¿').fontSize(14).fontColor('#ffffff').opacity(0.9).margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)
      }.width('100%').padding({ left: 24, right: 24, top: 40, bottom: 40 })
    }.width('100%').backgroundColor('#1890ff')
  }

  @Builder buildStatusPanel() {
    Row() {
      this.buildStatusItem('ç”µé‡', `${this.store.elderlyStatus?.batteryLevel ?? '--'}%`, '#52c41a')
      this.buildStatusItem('ä¿¡å·', 'è‰¯å¥½', '#1890ff')
      this.buildStatusItem('ç‰ˆæœ¬', 'v1.0.2', '#999')
    }
    .width('100%').padding(20).backgroundColor('#ffffff').borderRadius(16).justifyContent(FlexAlign.SpaceAround)
  }

  @Builder buildStatusItem(label: string, value: string, color: string) {
    Column() {
      Text(label).fontSize(12).fontColor('#999').margin({ bottom: 4 })
      Text(value).fontSize(16).fontWeight(FontWeight.Bold).fontColor(color)
    }
  }

  @Builder buildMenuRow(title: string, value: string, hasDivider: boolean, onClick: () => void) {
    Column() {
      Row() {
        Text(title).fontSize(15).fontColor('#333')
        Blank()
        Text(value).fontSize(14).fontColor('#1890ff').margin({ right: 8 })
        Text('>').fontSize(14).fontColor('#ccc')
      }
      .width('100%').height(64).padding({ left: 16, right: 16 })
      .onClick(onClick)

      if (hasDivider) {
        Divider().color('#f5f5f5').margin({ left: 16, right: 16 })
      }
    }
  }
}